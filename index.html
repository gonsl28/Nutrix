<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NutriAI - Sua Nutricionista de Bolso</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UMD Global para evitar erros de import map no mobile) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons (Global) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google GenAI SDK (ESM Module shim) -->
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.sh/@google/genai@0.1.1"
      }
    }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        /* Hide Scrollbar */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 h-screen overflow-hidden flex justify-center items-center">

    <!-- App Container -->
    <div id="root" class="w-full max-w-md h-[100dvh] bg-white shadow-xl overflow-hidden flex flex-col relative"></div>

    <!-- MAIN SCRIPT -->
    <script type="text/babel" data-type="module">
        import { GoogleGenAI } from "@google/genai";

        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        // --- ICONS (Lucide Wrapper for React) ---
        // Pequeno helper para usar ícones Lucide no React sem build complexo
        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size }}></i>;
        };

        // --- CONFIG ---
        const SHEETDB_URL = 'https://sheetdb.io/api/v1/bsk8mjfevtm3l';
        const GEMINI_API_KEY = "AIzaSyAkM07aMHk0p0-4gDAFL4gYqrzjzfpAbBQ";

        // --- TYPES/CONSTANTS ---
        const CookingTime = { FAST: 'Rápido (< 20min)', MEDIUM: 'Médio (30-45min)', ELABORATE: 'Elaborado (> 1h)' };
        const Goal = { LOSE: 'Perder Peso', MAINTAIN: 'Manter Peso', GAIN: 'Ganhar Massa', HEALTH: 'Reeducação' };

        const EMERGENCY_PLAN = {
            days: Array(7).fill(null).map((_, i) => ({
                day: ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'][i],
                meals: {
                    breakfast: { time: '08:00', name: 'Ovos Mexidos', ingredients: ['2 ovos', 'Pão integral'] },
                    lunch: { time: '12:00', name: 'Grelhado Simples', ingredients: ['Frango', 'Salada', 'Arroz'] },
                    snack: { time: '16:00', name: 'Fruta', ingredients: ['Maçã ou Banana'] },
                    dinner: { time: '20:00', name: 'Sopa Leve', ingredients: ['Legumes variados'] }
                }
            }))
        };

        // --- SERVICES ---
        const services = {
            getUser: async (email) => {
                try {
                    const res = await fetch(`${SHEETDB_URL}/search?email=${email}`);
                    const data = await res.json();
                    return data?.[0] || null;
                } catch { return null; }
            },
            createUser: async (email) => {
                const user = { email, data_cadastro: new Date().toISOString(), status_pagamento: 'pendente' };
                try {
                    await fetch(SHEETDB_URL, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ data: user })
                    });
                } catch {}
                return user;
            },
            generatePlan: async (profile) => {
                const getFallback = () => EMERGENCY_PLAN;
                try {
                    const ai = new GoogleGenAI({ apiKey: GEMINI_API_KEY });
                    const prompt = `Gere um plano alimentar de 7 dias (JSON) para: ${profile.age} anos, ${profile.weight}kg, Objetivo: ${profile.goal}. Restrições: ${profile.restrictions}. Retorne JSON no formato: { "days": [{ "day": "Segunda", "meals": { "breakfast": {"time":"", "name":"", "ingredients":[]}, "lunch": {...}, "snack": {...}, "dinner": {...} } }] }`;
                    
                    const res = await Promise.race([
                        ai.models.generateContent({ 
                            model: 'gemini-2.0-flash', 
                            contents: prompt, 
                            config: { responseMimeType: "application/json" } 
                        }),
                        new Promise((_, r) => setTimeout(() => r("timeout"), 12000))
                    ]);
                    
                    if (!res.text) return getFallback();
                    return JSON.parse(res.text.replace(/```json|```/g, '').trim());
                } catch (e) { console.error(e); return getFallback(); }
            },
            createChat: (profile, plan) => {
                const ai = new GoogleGenAI({ apiKey: GEMINI_API_KEY });
                const chat = ai.chats.create({
                    model: 'gemini-2.0-flash',
                    config: { systemInstruction: `NutriAI. Plano: ${JSON.stringify(plan).substring(0,500)}...` }
                });
                return { sendMessage: async (msg) => (await chat.sendMessage({ message: msg })).text };
            }
        };

        // --- COMPONENTS ---

        const Button = ({ children, onClick, disabled, className="" }) => (
            <button onClick={onClick} disabled={disabled} 
                className={`w-full py-3 rounded-xl font-bold bg-gradient-to-r from-orange-500 to-red-500 text-white shadow-lg active:scale-95 disabled:opacity-50 ${className}`}>
                {children}
            </button>
        );

        const LoadingScreen = () => (
            <div className="h-full flex flex-col items-center justify-center p-8 bg-white text-center">
                <div className="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center mb-6 animate-pulse">
                    <Icon name="chef-hat" className="text-orange-500" size={40} />
                </div>
                <h3 className="text-xl font-bold">Preparando seu plano...</h3>
                <div className="w-48 h-1 bg-gray-100 rounded-full mt-6 overflow-hidden">
                    <div className="h-full bg-orange-500 w-full animate-[loading_8s_ease-out_forwards]" style={{animation: 'loading 8s ease-out forwards'}}></div>
                </div>
            </div>
        );

        const LoginScreen = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [loading, setLoading] = useState(false);
            return (
                <div className="h-full bg-white flex flex-col p-8 justify-center items-center text-center fade-in">
                    <div className="w-20 h-20 bg-gradient-to-br from-orange-500 to-red-600 rounded-3xl flex items-center justify-center shadow-xl mb-4 rotate-3">
                        <Icon name="sparkles" className="text-white" size={40} />
                    </div>
                    <h1 className="text-3xl font-bold mb-8">NutriAI Web</h1>
                    <input type="email" placeholder="seu@email.com" value={email} onChange={e=>setEmail(e.target.value)} 
                        className="w-full p-4 bg-gray-50 border rounded-xl mb-4 focus:border-orange-500 outline-none" />
                    <Button onClick={() => { setLoading(true); onLogin(email); }} disabled={!email.includes('@') || loading}>
                        {loading ? 'Entrando...' : 'Começar Agora'}
                    </Button>
                </div>
            );
        };

        const PaymentScreen = () => {
            const [time, setTime] = useState("03:47:22");
            useEffect(() => {
                let s = 13642; 
                const t = setInterval(() => {
                    s--;
                    const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
                    setTime(`${h}:${m<10?'0'+m:m}:${sec<10?'0'+sec:sec}`);
                }, 1000);
                return () => clearInterval(t);
            }, []);
            
            return (
                <div className="h-full bg-white overflow-y-auto pb-10">
                    <header className="bg-gradient-to-r from-orange-500 to-orange-400 p-6 rounded-b-3xl text-center shadow-lg text-white">
                        <Icon name="clock" className="mx-auto mb-2" />
                        <p className="text-sm opacity-90">OFERTA EXPIRA EM</p>
                        <div className="text-2xl font-mono font-black">{time}</div>
                    </header>
                    <div className="p-6 space-y-6 text-center">
                        <h2 className="text-2xl font-bold text-orange-600">Não perca sua evolução.</h2>
                        <div className="bg-orange-50 p-4 rounded-xl border-l-4 border-orange-500 text-left text-sm">
                            <p className="font-bold mb-2">Sem o NutriAI:</p>
                            <p>❌ Sem saber o que comer</p>
                            <p>❌ Compras erradas no mercado</p>
                        </div>
                        <div className="bg-white border rounded-2xl p-4 shadow-xl">
                            <p className="line-through text-gray-400">R$ 49,90</p>
                            <p className="text-3xl font-black text-green-600">R$ 13,99<span className="text-sm text-gray-500 font-normal">/mês</span></p>
                            <p className="text-xs text-orange-500 font-bold mt-1">MENOS QUE UM CAFÉ ☕</p>
                        </div>
                        <Button onClick={() => window.open('https://pay.cakto.com.br/3fotcu8_725073')}>QUERO CONTINUAR MAGRA</Button>
                    </div>
                </div>
            );
        };

        const Onboarding = ({ onSubmit }) => {
            const [step, setStep] = useState(1);
            const [data, setData] = useState({ gender: 'Feminino', goal: Goal.LOSE, cookingTime: CookingTime.MEDIUM, favorites: [] });
            
            const update = (k, v) => setData(p => ({...p, [k]: v}));
            const toggleFav = (f) => update('favorites', data.favorites.includes(f) ? data.favorites.filter(i=>i!==f) : [...data.favorites, f]);
            
            const renderStep = () => {
                if(step === 1) return (
                    <div className="space-y-4 fade-in">
                        <h2 className="text-2xl font-bold text-center">Seus Dados</h2>
                        <input type="number" placeholder="Idade" className="w-full p-3 bg-gray-50 border rounded-xl" onChange={e=>update('age', e.target.value)} />
                        <input type="number" placeholder="Peso (kg)" className="w-full p-3 bg-gray-50 border rounded-xl" onChange={e=>update('weight', e.target.value)} />
                        <input type="number" placeholder="Altura (cm)" className="w-full p-3 bg-gray-50 border rounded-xl" onChange={e=>update('height', e.target.value)} />
                    </div>
                );
                if(step === 2) return (
                    <div className="space-y-4 fade-in">
                        <h2 className="text-2xl font-bold text-center">Objetivo</h2>
                        {Object.values(Goal).map(g => (
                            <div key={g} onClick={()=>update('goal', g)} 
                                className={`p-4 border-2 rounded-xl ${data.goal===g ? 'border-orange-500 bg-orange-50' : 'border-transparent bg-gray-50'}`}>{g}</div>
                        ))}
                    </div>
                );
                if(step === 3) return (
                    <div className="space-y-4 fade-in">
                        <h2 className="text-2xl font-bold text-center">Rotina</h2>
                        {Object.values(CookingTime).map(t => (
                            <div key={t} onClick={()=>update('cookingTime', t)}
                                className={`p-3 border rounded-xl ${data.cookingTime===t ? 'bg-orange-500 text-white' : 'bg-white'}`}>{t}</div>
                        ))}
                        <textarea placeholder="Restrições (ex: sem glúten)" className="w-full p-3 border rounded-xl" onChange={e=>update('restrictions', e.target.value)}></textarea>
                    </div>
                );
                return (
                    <div className="space-y-4 h-[400px] overflow-y-auto fade-in">
                        <h2 className="text-2xl font-bold text-center">Favoritos</h2>
                        {['Ovos','Frango','Batata','Arroz','Feijão','Salada','Frutas','Chocolate','Café'].map(f => (
                            <button key={f} onClick={()=>toggleFav(f)} 
                                className={`m-1 px-3 py-1 rounded-lg border ${data.favorites.includes(f) ? 'bg-orange-500 text-white' : 'bg-white'}`}>{f}</button>
                        ))}
                    </div>
                );
            };

            return (
                <div className="h-full bg-white p-6 flex flex-col">
                    <div className="flex justify-center gap-2 mb-6">{[1,2,3,4].map(i => <div key={i} className={`h-1 w-8 rounded ${i<=step?'bg-orange-500':'bg-gray-200'}`}></div>)}</div>
                    <div className="flex-1 flex flex-col justify-center">{renderStep()}</div>
                    <Button onClick={() => step < 4 ? setStep(s=>s+1) : onSubmit(data)} disabled={step===1 && !data.weight}>
                        {step===4 ? 'Gerar Dieta' : 'Continuar'}
                    </Button>
                </div>
            );
        };

        const Dashboard = ({ plan, profile, isVip }) => {
            const [tab, setTab] = useState('plan');
            const [msgs, setMsgs] = useState([]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [expanded, setExpanded] = useState(plan.days[0].day);
            const chatRef = useRef(null);

            useEffect(() => { if(!chatRef.current) chatRef.current = services.createChat(profile, plan); }, []);

            const send = async () => {
                if(!input) return;
                const txt = input; setInput(''); setLoading(true); setMsgs(p=>[...p, {role:'user', text:txt}]); setTab('chat');
                try {
                    const res = await chatRef.current.sendMessage(txt);
                    setMsgs(p=>[...p, {role:'model', text:res}]);
                } catch { setMsgs(p=>[...p, {role:'model', text:'Erro de conexão.'}]); }
                setLoading(false);
            };

            return (
                <div className="flex flex-col h-full bg-gray-50">
                    <div className="bg-white flex shadow-sm sticky top-0 z-10">
                        <button onClick={()=>setTab('plan')} className={`flex-1 p-4 font-bold border-b-2 ${tab==='plan'?'border-orange-500 text-orange-500':'border-transparent text-gray-400'}`}>Plano</button>
                        <button onClick={()=>setTab('chat')} className={`flex-1 p-4 font-bold border-b-2 ${tab==='chat'?'border-orange-500 text-orange-500':'border-transparent text-gray-400'}`}>Chat IA</button>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {tab === 'plan' ? (
                            <div className="fade-in space-y-4 pb-20">
                                <div className="bg-gradient-to-r from-orange-500 to-red-500 text-white p-6 rounded-2xl shadow-lg">
                                    <h2 className="text-2xl font-bold">Seu Plano</h2>
                                    <p className="opacity-90">{profile.goal}</p>
                                </div>
                                {plan.days.map(d => (
                                    <div key={d.day} className="bg-white rounded-xl shadow border overflow-hidden">
                                        <div onClick={()=>setExpanded(expanded===d.day?'':d.day)} className="p-4 font-bold flex justify-between items-center bg-gray-50">
                                            {d.day} <Icon name={expanded===d.day?'chevron-up':'chevron-down'} size={16}/>
                                        </div>
                                        {expanded===d.day && <div className="p-4 space-y-4">
                                            {Object.entries(d.meals).map(([k,m]) => (
                                                <div key={k} className="border-l-4 border-orange-200 pl-3">
                                                    <div className="font-bold text-gray-700 capitalize">{k} <span className="text-xs font-normal bg-gray-100 px-2 rounded-full">{m.time}</span></div>
                                                    <div className="text-orange-600 font-medium">{m.name}</div>
                                                    <div className="text-sm text-gray-500">{m.ingredients.join(', ')}</div>
                                                </div>
                                            ))}
                                        </div>}
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="space-y-4 pb-20 fade-in">
                                {msgs.map((m,i) => (
                                    <div key={i} className={`flex ${m.role==='user'?'justify-end':'justify-start'}`}>
                                        <div className={`p-3 rounded-2xl max-w-[80%] ${m.role==='user'?'bg-orange-500 text-white':'bg-white border'}`}>{m.text}</div>
                                    </div>
                                ))}
                                {loading && <div className="text-center text-gray-400 text-sm">Digitando...</div>}
                            </div>
                        )}
                    </div>

                    {tab === 'chat' && (
                        <div className="p-4 bg-white border-t flex gap-2">
                            <input value={input} onChange={e=>setInput(e.target.value)} placeholder="Tire sua dúvida..." className="flex-1 p-3 border rounded-xl" />
                            <button onClick={send} className="p-3 bg-orange-500 text-white rounded-xl"><Icon name="send" /></button>
                        </div>
                    )}
                    
                    {!isVip && tab === 'plan' && (
                        <div className="bg-gray-900 text-white p-3 text-center text-xs sticky bottom-0 cursor-pointer" onClick={() => window.open('https://pay.cakto.com.br/3fotcu8_725073')}>
                            Teste Grátis. <span className="font-bold text-orange-400">Clique para liberar acesso total.</span>
                        </div>
                    )}
                </div>
            );
        };

        // --- APP ROOT ---
        const App = () => {
            const [step, setStep] = useState('loading'); // start with loading to check user
            const [user, setUser] = useState(null);
            const [plan, setPlan] = useState(null);
            const [isVip, setIsVip] = useState(false);

            useEffect(() => {
                const email = localStorage.getItem('nutri_mail');
                if(email) checkUser(email); else setStep('login');
            }, []);

            const checkUser = async (email) => {
                setStep('loading');
                let u = await services.getUser(email);
                if(!u) u = await services.createUser(email);
                
                setUser(u);
                localStorage.setItem('nutri_mail', email);

                const isPaid = u.status_pagamento === 'pago';
                const hours = (new Date() - new Date(u.data_cadastro)) / 36e5;

                if (isPaid) { setIsVip(true); setStep('onboarding'); }
                else if (hours < 24) { setIsVip(false); setStep('onboarding'); }
                else { setStep('payment'); }
            };

            const handleForm = async (data) => {
                setStep('loading');
                const p = await services.generatePlan({...user, ...data});
                setPlan(p);
                setStep('dashboard');
            };

            return (
                <>
                    {step === 'login' && <LoginScreen onLogin={checkUser} />}
                    {step === 'loading' && <LoadingScreen />}
                    {step === 'payment' && <PaymentScreen />}
                    {step === 'onboarding' && <Onboarding onSubmit={handleForm} />}
                    {step === 'dashboard' && <Dashboard plan={plan} profile={user} isVip={isVip} />}
                </>
            );
        };

        // MOUNT
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
