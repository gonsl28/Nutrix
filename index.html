<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="color-scheme" content="light only">
    <title>NutriAI - Sua Nutricionista de Bolso</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & React DOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
      
      /* FOR√áA LIGHT MODE - DESATIVA DARK MODE COMPLETAMENTE */
      :root {
        color-scheme: light only;
      }
      
      /* For√ßa fundo branco e previne dark mode */
      html, body {
        background-color: #ffffff !important;
        color: #111827 !important;
      }
      
      body { font-family: 'Inter', sans-serif; }
      
      /* Animations */
      @keyframes fade-in {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
      
      @keyframes slide-up {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
      }
      .animate-slide-up { animation: slide-up 0.3s ease-out forwards; }
      
      @keyframes pulse-soft {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
      }
      .animate-pulse-soft { animation: pulse-soft 2s infinite; }

      @keyframes loading {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
      }

      /* Scrollbar Hide */
      .scrollbar-hide::-webkit-scrollbar { display: none; }
      .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-white text-gray-900 h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONFIGURA√á√ïES ---
        const SHEETDB_URL = 'https://sheetdb.io/api/v1/bsk8mjfevtm3l';
        const GEMINI_API_KEY = "AIzaSyCAaX3PAxJ3BlSJyGOTWFUTC8VBTYd8vow"; 
        const CAKTO_LINK = "https://pay.cakto.com.br/3fotcu8_725073";

        // --- TYPES E DADOS ---
        const CookingTime = {
            FAST: 'R√°pido (< 20min)',
            MEDIUM: 'M√©dio (30-45min)',
            ELABORATE: 'Elaborado (> 1h)'
        };

        const Goal = {
            LOSE_WEIGHT: 'Perder Peso',
            MAINTAIN: 'Manter Peso',
            GAIN_MUSCLE: 'Ganhar Massa Muscular',
            HEALTHY_EATING: 'Reeduca√ß√£o Alimentar'
        };

        const EMERGENCY_PLAN = {
            days: Array(7).fill(null).map((_, i) => {
                const days = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado', 'Domingo'];
                return {
                    day: days[i],
                    meals: {
                        breakfast: { time: '08:00', name: 'Ovos com Torrada', ingredients: ['2 ovos mexidos', '1 fatia p√£o integral', 'Caf√©'] },
                        lunch: { time: '12:00', name: 'Grelhado com Salada', ingredients: ['150g Frango', 'Salada variada', 'Arroz integral'] },
                        snack: { time: '16:00', name: 'Fruta + Castanhas', ingredients: ['1 Ma√ß√£', '10g castanhas'] },
                        dinner: { time: '20:00', name: 'Jantar Leve', ingredients: ['Omelete ou Sopa', 'Salada de folhas'] }
                    }
                };
            })
        };

        // --- LUCIDE ICONS (SVG Components) ---
        const Sparkles = () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3l1.5 5L11 9.5 6.5 11 5 16l-1.5-5L-1 9.5 3.5 8 5 3zM19 12l-1 3-3 1 3 1 1 3 1-3 3-1-3-1-1-3z" /></svg>;
        const ArrowRight = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>;
        const Lock = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>;
        const ChefHat = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.5a4 4 0 00-4-4 4 4 0 00-4 4v.5a4 4 0 004 4h8a4 4 0 004-4v-.5a4 4 0 00-4-4 4 4 0 00-4 4zM5 10.5v7a2 2 0 002 2h10a2 2 0 002-2v-7" /></svg>;
        const Clock = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" strokeWidth={2}/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6l4 2"/></svg>;
        const X = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12"/></svg>;
        const Check = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7"/></svg>;
        const ChevronDown = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7"/></svg>;
        const ChevronUp = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7"/></svg>;
        const ChevronRight = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7"/></svg>;
        const Send = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>;
        const MessageCircle = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>;
        const Calendar = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" strokeWidth={2}/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 2v4M8 2v4M3 10h18"/></svg>;
        const Crown = ({className}) => <svg className={className} fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l2.5 5 5.5.5-4 4 1 5.5-5-3-5 3 1-5.5-4-4 5.5-.5z"/></svg>;
        const Flame = ({className}) => <svg className={className} fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C8 6 6 10 6 14c0 3.31 2.69 6 6 6s6-2.69 6-6c0-4-2-8-6-12z"/></svg>;

        // --- SERVICES ---
        const sheetDbService = {
            getUserByEmail: async (email) => {
                try {
                    const response = await fetch(`${SHEETDB_URL}/search?email=${email}`);
                    const data = await response.json();
                    return (Array.isArray(data) && data.length > 0) ? data[0] : null;
                } catch (error) {
                    console.error("Erro SheetDB", error);
                    return null;
                }
            },
            createUser: async (email) => {
                const newUser = {
                    email,
                    data_cadastro: new Date().toISOString(),
                    status_pagamento: 'pendente'
                };
                try {
                    await fetch(SHEETDB_URL, {
                        method: 'POST',
                        headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
                        body: JSON.stringify({ data: newUser })
                    });
                    return newUser;
                } catch (error) {
                    console.error("Erro criar user", error);
                    return newUser;
                }
            }
        };

        // Gemini Service (CORRIGIDO + DEBUG)
        const generateMealPlan = async (profile) => {
            const getFallback = () => EMERGENCY_PLAN;

            try {
                console.log("üî• Iniciando gera√ß√£o de plano...");
                const favoritesList = profile.favorites ? profile.favorites.join(', ') : 'Variado';
                
                const prompt = `Crie um plano alimentar semanal de 7 dias (Segunda a Domingo) em JSON.
Perfil: ${profile.age} anos, ${profile.weight}kg, ${profile.height}cm.
Objetivo: ${profile.objective}.
Tempo cozinha: ${profile.cookingTime}.
Favoritos: ${favoritesList}.
Restri√ß√µes: ${profile.restrictions || 'Nenhuma'}.

Retorne APENAS um JSON v√°lido no formato:
{
  "days": [
    {
      "day": "Segunda-feira",
      "meals": {
        "breakfast": { "time": "08:00", "name": "Nome", "ingredients": ["item1", "item2"] },
        "lunch": { "time": "12:00", "name": "Nome", "ingredients": ["item1"] },
        "snack": { "time": "16:00", "name": "Nome", "ingredients": ["item1"] },
        "dinner": { "time": "20:00", "name": "Nome", "ingredients": ["item1"] }
      }
    }
  ]
}`;

                console.log("üì° Fazendo request para Gemini...");
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                console.log("üìä Status da resposta:", response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("‚ùå Erro da API:", errorText);
                    alert(`Erro Gemini: ${response.status} - ${errorText.substring(0, 100)}`);
                    throw new Error('API Error');
                }
                
                const data = await response.json();
                console.log("‚úÖ Resposta recebida:", data);
                
                const text = data.candidates[0].content.parts[0].text;
                const cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const parsed = JSON.parse(cleanText);
                console.log("üéâ Plano gerado com sucesso!");
                return parsed;

            } catch (error) {
                console.error("üí• Erro completo:", error);
                alert(`ERRO DETALHADO: ${error.message}`);
                return getFallback();
            }
        };

        const createChatSession = (profile, plan) => {
            return {
                sendMessage: async (text) => {
                    try {
                        console.log("üí¨ Enviando mensagem:", text);
                        const prompt = `Contexto: Plano nutricional de ${profile.objective}. Responda curto e amig√°vel: ${text}`;
                        
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }]
                            })
                        });

                        console.log("üìä Status chat:", response.status);

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error("‚ùå Erro chat:", errorText);
                            alert(`Erro Chat: ${response.status} - Verifique a API key!`);
                            return { text: `Erro ${response.status}: API key pode estar inv√°lida ou sem cota.` };
                        }

                        const data = await response.json();
                        console.log("‚úÖ Resposta chat recebida");
                        return { text: data.candidates[0].content.parts[0].text };
                    } catch(e) { 
                        console.error("üí• Erro chat completo:", e);
                        return { text: `Erro: ${e.message}` }; 
                    }
                }
            };
        };

        // --- COMPONENTS ---
        const Button = ({ children, variant = 'primary', fullWidth = false, className = '', ...props }) => {
            const base = "px-6 py-3 rounded-xl font-bold transition-all active:scale-95 disabled:opacity-50 disabled:active:scale-100";
            const variants = {
                primary: "bg-gradient-to-r from-orange-500 to-red-500 text-white shadow-lg hover:shadow-orange-500/30",
                secondary: "bg-orange-100 text-orange-700 hover:bg-orange-200",
                outline: "border-2 border-orange-500 text-orange-600 hover:bg-orange-50"
            };
            return <button className={`${base} ${variants[variant]} ${fullWidth ? 'w-full' : ''} ${className}`} {...props}>{children}</button>;
        };

        const LoginScreen = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!email.includes('@')) return;
                setLoading(true);
                await onLogin(email);
                setLoading(false);
            };

            return (
                <div className="h-full bg-white flex flex-col p-8 animate-fade-in relative overflow-hidden">
                    <div className="absolute top-0 right-0 w-64 h-64 bg-orange-100 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 opacity-50 pointer-events-none"></div>
                    <div className="flex-1 flex flex-col justify-center items-center text-center space-y-8 z-10">
                        <div className="w-20 h-20 bg-gradient-to-br from-orange-500 to-red-600 rounded-3xl flex items-center justify-center shadow-xl mb-4 transform rotate-3">
                            <Sparkles className="w-10 h-10 text-white" />
                        </div>
                        <div className="space-y-2">
                            <h1 className="text-3xl font-bold text-gray-900">NutriAI Web</h1>
                            <p className="text-gray-500">Sua nutricionista pessoal de bolso.</p>
                        </div>
                        <form onSubmit={handleSubmit} className="w-full max-w-xs space-y-4">
                            <div className="text-left">
                                <label className="block text-sm font-medium text-gray-700 mb-1 ml-1">Seu melhor e-mail</label>
                                <input type="email" required placeholder="exemplo@email.com" value={email} onChange={(e) => setEmail(e.target.value)}
                                    className="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:border-orange-500 outline-none transition-all" />
                            </div>
                            <Button fullWidth type="submit" disabled={loading || !email} className="flex items-center justify-center gap-2 py-4 text-lg">
                                {loading ? 'Verificando...' : <><span>Come√ßar Agora</span> <ArrowRight className="w-5 h-5" /></>}
                            </Button>
                        </form>
                        <p className="text-xs text-gray-400 flex items-center gap-1 justify-center mt-4">
                            <Lock className="w-3 h-3" /> Seus dados est√£o seguros
                        </p>
                    </div>
                </div>
            );
        };

        const Onboarding = ({ onSubmit }) => {
            const [step, setStep] = useState(1);
            const [formData, setFormData] = useState({ gender: 'Feminino', goal: Goal.LOSE_WEIGHT, cookingTime: CookingTime.MEDIUM, favorites: [] });

            const handleChange = (field, value) => setFormData(prev => ({ ...prev, [field]: value }));
            const toggleFavorite = (id) => {
                setFormData(prev => ({ ...prev, favorites: prev.favorites.includes(id) ? prev.favorites.filter(f => f !== id) : [...prev.favorites, id] }));
            };
            const handleNext = () => step < 4 ? setStep(step + 1) : onSubmit(formData);

            const foodCategories = [
                { label: "üçö Carboidratos", items: [{id: 'arroz', label: 'Arroz'}, {id: 'batata', label: 'Batata'}, {id: 'pao', label: 'P√£o'}] },
                { label: "üçó Prote√≠nas", items: [{id: 'frango', label: 'Frango'}, {id: 'ovos', label: 'Ovos'}, {id: 'carne', label: 'Carne'}] },
                { label: "ü•¶ Vegetais", items: [{id: 'alface', label: 'Alface'}, {id: 'tomate', label: 'Tomate'}, {id: 'cenoura', label: 'Cenoura'}] }
            ];

            const renderStep1 = () => (
                <div className="space-y-6 animate-fade-in">
                    <div className="text-center mb-6"><h2 className="text-2xl font-bold">Sobre voc√™</h2></div>
                    <div className="grid grid-cols-2 gap-4">
                        <input type="number" placeholder="Idade" className="p-3 bg-gray-50 rounded-xl border w-full" onChange={e => handleChange('age', e.target.value)} />
                        <select className="p-3 bg-gray-50 rounded-xl border w-full" onChange={e => handleChange('gender', e.target.value)}><option>Feminino</option><option>Masculino</option></select>
                        <input type="number" placeholder="Peso (kg)" className="p-3 bg-gray-50 rounded-xl border w-full" onChange={e => handleChange('weight', e.target.value)} />
                        <input type="number" placeholder="Altura (cm)" className="p-3 bg-gray-50 rounded-xl border w-full" onChange={e => handleChange('height', e.target.value)} />
                    </div>
                </div>
            );

            const renderStep2 = () => (
                <div className="space-y-3 animate-fade-in">
                    <div className="text-center mb-6"><h2 className="text-2xl font-bold">Objetivo</h2></div>
                    {Object.values(Goal).map(g => (
                        <button key={g} onClick={() => { handleChange('goal', g); handleChange('objective', g); }}
                            className={`w-full p-4 rounded-xl text-left border-2 ${formData.goal === g ? 'border-orange-500 bg-orange-50 text-orange-700' : 'border-transparent bg-gray-50'}`}>
                            {g}
                        </button>
                    ))}
                </div>
            );

            const renderStep3 = () => (
                <div className="space-y-4 animate-fade-in">
                    <div className="text-center mb-6"><h2 className="text-2xl font-bold">Rotina</h2></div>
                    <label className="block text-sm font-bold">Tempo para cozinhar</label>
                    {Object.values(CookingTime).map(t => (
                        <button key={t} onClick={() => handleChange('cookingTime', t)} className={`w-full p-3 rounded-lg text-sm border ${formData.cookingTime === t ? 'bg-orange-500 text-white' : 'bg-white'}`}>{t}</button>
                    ))}
                    <label className="block text-sm font-bold mt-4">Restri√ß√µes (Opcional)</label>
                    <textarea className="w-full p-3 bg-gray-50 rounded-xl border" placeholder="Ex: Intolerante a lactose" onChange={e => handleChange('restrictions', e.target.value)} />
                </div>
            );

            const renderStep4 = () => (
                <div className="space-y-4 animate-fade-in h-[400px] overflow-y-auto">
                    <div className="text-center"><h2 className="text-2xl font-bold">Favoritos</h2><p className="text-sm text-gray-500">Selecione o que gosta</p></div>
                    {foodCategories.map(cat => (
                        <div key={cat.label}>
                            <h4 className="font-bold text-sm mb-2">{cat.label}</h4>
                            <div className="flex flex-wrap gap-2">
                                {cat.items.map(item => (
                                    <button key={item.id} onClick={() => toggleFavorite(item.id)}
                                        className={`px-3 py-1.5 rounded-lg text-sm border ${formData.favorites.includes(item.id) ? 'bg-orange-500 text-white' : 'bg-white'}`}>
                                        {item.label}
                                    </button>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            );

            return (
                <div className="flex flex-col h-full bg-white p-6">
                    <div className="flex justify-center mb-6 gap-2">
                        {[1,2,3,4].map(i => <div key={i} className={`h-1.5 rounded-full transition-all ${i<=step ? 'w-8 bg-orange-500' : 'w-2 bg-gray-200'}`} />)}
                    </div>
                    <div className="flex-1 flex flex-col justify-center max-w-sm mx-auto w-full">
                        {step === 1 && renderStep1()}
                        {step === 2 && renderStep2()}
                        {step === 3 && renderStep3()}
                        {step === 4 && renderStep4()}
                    </div>
                    <div className="mt-auto pt-6">
                        <Button fullWidth onClick={handleNext} disabled={step===1 && (!formData.age || !formData.weight)}>
                            {step === 4 ? <span className="flex items-center gap-2 justify-center"><Flame className="w-5 h-5"/> Gerar Dieta</span> : <span className="flex items-center gap-2 justify-center">Continuar <ChevronRight className="w-5 h-5"/></span>}
                        </Button>
                    </div>
                </div>
            );
        };

        const LoadingScreen = () => {
            const [msg, setMsg] = useState("Analisando perfil...");
            useEffect(() => {
                const msgs = ["Calculando macros...", "Selecionando receitas...", "Montando card√°pio...", "Finalizando..."];
                let i = 0;
                const interval = setInterval(() => { setMsg(msgs[i]); i = (i+1)%msgs.length; }, 2000);
                return () => clearInterval(interval);
            }, []);
            return (
                <div className="h-full bg-white flex flex-col items-center justify-center p-8 text-center">
                    <div className="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center mb-6 animate-pulse">
                        <ChefHat className="w-10 h-10 text-orange-500" />
                    </div>
                    <h3 className="text-xl font-bold">Criando seu Plano</h3>
                    <p className="text-gray-500 mt-2">{msg}</p>
                    <div className="w-48 h-1 bg-gray-100 rounded-full overflow-hidden mt-6">
                        <div className="h-full bg-orange-500 animate-[loading_8s_ease-out_forwards]" style={{width:'100%'}}></div>
                    </div>
                </div>
            );
        };

        const PaymentScreen = () => {
            const [time, setTime] = useState({ h: 3, m: 47, s: 22 });
            useEffect(() => {
                const t = setInterval(() => {
                    setTime(p => {
                        if (p.s > 0) return { ...p, s: p.s - 1 };
                        if (p.m > 0) return { ...p, m: p.m - 1, s: 59 };
                        if (p.h > 0) return { ...p, h: p.h - 1, m: 59, s: 59 };
                        return p;
                    });
                }, 1000);
                return () => clearInterval(t);
            }, []);
            const fmt = (n) => n.toString().padStart(2, '0');

            return (
                <div className="min-h-screen bg-white text-[#2B2D42] overflow-y-auto pb-10">
                    <header className="bg-gradient-to-r from-[#FF6B35] to-[#FFA500] pt-6 pb-8 px-4 rounded-b-[2rem] shadow-xl relative z-10 text-center">
                        <div className="bg-white/20 p-3 rounded-2xl backdrop-blur-sm inline-block mb-4"><ChefHat className="w-8 h-8 text-white" /></div>
                        <p className="text-white text-sm font-medium mb-2 opacity-90">‚è∞ SEU ACESSO EXPIRA EM:</p>
                        <div className="bg-white px-6 py-2 rounded-full shadow-lg inline-flex items-center gap-2">
                            <Clock className="w-4 h-4 text-[#E63946]" />
                            <span className="text-[#E63946] text-xl font-black font-mono">{fmt(time.h)}:{fmt(time.m)}:{fmt(time.s)}</span>
                        </div>
                    </header>

                    <div className="max-w-md mx-auto">
                        <section className="px-8 py-8 text-center">
                            <h1 className="text-[#FF6B35] text-2xl font-extrabold leading-tight mb-4">"Nas √∫ltimas 24h voc√™ teve clareza sobre o que comer."</h1>
                            <p className="text-lg font-medium opacity-80">Voc√™ realmente vai <span className="underline decoration-[#E63946]">PERDER</span> isso?</p>
                        </section>

                        <section className="px-6 py-2">
                            <div className="bg-[#FFF8E1] p-6 rounded-r-2xl border-l-4 border-[#E63946] shadow-sm">
                                <h3 className="font-bold text-lg mb-4">Imagine amanh√£ sem Nutrix:</h3>
                                <ul className="space-y-3 mb-6">
                                    {['Acordar sem saber o que comer', 'Perdido no supermercado', 'Comendo qualquer coisa'].map((it,i)=>(
                                        <li key={i} className="flex gap-2 text-sm"><X className="w-5 h-5 text-[#E63946]"/> {it}</li>
                                    ))}
                                </ul>
                                <p className="text-[#E63946] font-black text-center text-xs uppercase">√â ISSO QUE VOC√ä QUER?</p>
                            </div>
                        </section>

                        <section className="px-6 py-8 bg-white text-center space-y-4">
                            <p className="text-sm">‚ö†Ô∏è <strong>67% dos brasileiros n√£o sabem comer bem</strong> (IBGE)</p>
                            <p className="text-sm">üìä <strong>Falta de nutri√ß√£o aumenta risco de diabetes em 58%</strong></p>
                            <p className="text-[#FF6B35] font-bold text-lg pt-2">Por que voltar para a estat√≠stica?</p>
                        </section>

                        <section className="bg-gradient-to-b from-[#FF6B35]/10 to-white py-8 px-6">
                            <div className="bg-white rounded-3xl shadow-xl border border-gray-100 p-6 relative text-center overflow-hidden">
                                <div className="absolute top-0 right-0 bg-[#FF6B35] text-white text-[10px] font-bold px-3 py-1 rounded-bl-xl">MELHOR OFERTA</div>
                                <div className="space-y-4 mb-6">
                                    <div className="flex justify-between opacity-50 line-through text-sm"><span>‚ùå Presencial</span><span>R$250/h</span></div>
                                    <div className="flex justify-between font-bold text-lg bg-green-50 p-2 rounded border border-green-100 text-[#2B2D42]">
                                        <span className="flex gap-2"><Check className="w-4 h-4 text-green-600"/> Nutrix 24/7</span>
                                        <span className="text-green-700">R$13,99/m√™s</span>
                                    </div>
                                </div>
                                <div className="border-t border-dashed border-gray-200 pt-6">
                                    <p className="text-gray-400 text-xs font-bold uppercase">Custa apenas</p>
                                    <div className="flex justify-center items-baseline gap-1 text-[#FF6B35]"><span className="text-4xl font-black">R$0,46</span><span className="text-sm font-bold">/dia</span></div>
                                </div>
                            </div>
                        </section>

                        <section className="px-4 py-8 text-center">
                            <p className="mb-6 font-medium">Voltar pra confus√£o ou continuar com clareza?<br/><strong className="text-[#FF6B35]">A escolha √© √≥bvia.</strong></p>
                            <button onClick={() => window.open(CAKTO_LINK, '_blank')} 
                                className="w-full bg-gradient-to-r from-[#FF6B35] to-[#E63946] text-white py-5 rounded-2xl shadow-lg hover:scale-105 transition-transform animate-[pulse_3s_infinite]">
                                <div className="flex items-center justify-center gap-2">
                                    <span className="font-bold text-lg uppercase">CONTINUAR POR R$13,99</span>
                                    <ArrowRight className="w-5 h-5"/>
                                </div>
                            </button>
                            <button className="mt-6 text-xs text-gray-400">N√£o, prefiro n√£o saber o que comer</button>
                        </section>
                        
                        <footer className="text-center pb-8 px-4 text-[10px] text-gray-400 flex justify-center gap-2"><Lock className="w-3 h-3"/> Pagamento Seguro ‚Ä¢ Cancelamento F√°cil</footer>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ plan, profile, isVip }) => {
            const [tab, setTab] = useState('plan');
            const [msgs, setMsgs] = useState([]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [expandedDay, setExpanded] = useState(plan.days[0]?.day || '');
            const chatRef = useRef(null);
            const scrollRef = useRef(null);

            useEffect(() => {
                if(!chatRef.current) chatRef.current = createChatSession(profile, plan);
            }, [profile, plan]);
            
            useEffect(() => { scrollRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [msgs, tab]);

            const send = async (txt) => {
                if(!txt.trim() || loading) return;
                const userMsg = { id: Date.now(), role: 'user', text: txt };
                setMsgs(p => [...p, userMsg]);
                setInput(''); setLoading(true); setTab('chat');
                const res = await chatRef.current.sendMessage(txt);
                setMsgs(p => [...p, { id: Date.now()+1, role: 'model', text: res.text }]);
                setLoading(false);
            };

            const renderPlan = () => (
                <div className="pb-24 animate-fade-in">
                    <div className="bg-gradient-to-r from-orange-500 to-red-500 text-white p-6 rounded-b-3xl mb-6 shadow-lg">
                        <div className="flex justify-between mb-2 opacity-90">
                            <span className="text-xs font-bold uppercase flex gap-1"><Sparkles className="w-4 h-4"/> Plano Gerado</span>
                            {isVip && <span className="bg-white/20 px-2 rounded-full text-xs font-bold flex gap-1"><Crown className="w-3 h-3 text-yellow-300"/> VIP</span>}
                        </div>
                        <h2 className="text-2xl font-bold">Seu Plano Semanal</h2>
                        <p className="text-orange-100 text-sm">{profile.objective}</p>
                    </div>
                    <div className="px-4 space-y-4">
                        {plan.days.map((d, i) => {
                            const open = expandedDay === d.day;
                            return (
                                <div key={i} className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                                    <button onClick={() => setExpanded(open ? '' : d.day)} className={`w-full p-4 flex justify-between font-bold text-lg ${open ? 'bg-orange-50 text-orange-700' : 'text-gray-700'}`}>
                                        {d.day} {open ? <ChevronUp className="w-5 h-5"/> : <ChevronDown className="w-5 h-5"/>}
                                    </button>
                                    {open && <div className="p-4 space-y-6 bg-white animate-fade-in">
                                        {Object.entries(d.meals).map(([type, meal]) => {
                                            const labels = { breakfast: 'üç≥ Caf√©', lunch: 'üçΩÔ∏è Almo√ßo', snack: 'ü•§ Lanche', dinner: 'üåô Jantar' };
                                            return (
                                                <div key={type} className="border-l-4 border-orange-200 pl-4">
                                                    <div className="flex justify-between mb-1">
                                                        <h4 className="font-bold text-gray-800">{labels[type]}</h4>
                                                        <span className="text-xs bg-gray-100 px-2 py-1 rounded-full">{meal.time}</span>
                                                    </div>
                                                    <p className="text-orange-600 font-medium mb-1">{meal.name}</p>
                                                    <ul className="text-sm text-gray-600 mb-2">{meal.ingredients.map((ig, k) => <li key={k}>‚Ä¢ {ig}</li>)}</ul>
                                                    <button onClick={() => send(`Varia√ß√£o para ${meal.name} no ${d.day}`)} className="text-xs font-bold text-orange-500 flex items-center gap-1 bg-orange-50 px-2 py-1 rounded"><ChefHat className="w-3 h-3"/> Varia√ß√µes</button>
                                                </div>
                                            );
                                        })}
                                    </div>}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );

            const renderChat = () => (
                <div className="flex flex-col h-full bg-gray-50 pb-20 animate-fade-in">
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {msgs.length === 0 && <div className="text-center py-10 opacity-60"><p>üëã Ol√°! Pergunte sobre sua dieta.</p></div>}
                        {msgs.map(m => (
                            <div key={m.id} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] p-4 rounded-2xl text-sm ${m.role === 'user' ? 'bg-orange-500 text-white rounded-tr-none' : 'bg-white text-gray-800 border border-gray-100 rounded-tl-none'}`}>{m.text}</div>
                            </div>
                        ))}
                        {loading && <div className="flex"><div className="bg-white p-3 rounded-2xl border flex gap-1"><div className="w-2 h-2 bg-orange-400 rounded-full animate-bounce"/><div className="w-2 h-2 bg-orange-400 rounded-full animate-bounce" style={{animationDelay:'75ms'}}/><div className="w-2 h-2 bg-orange-400 rounded-full animate-bounce" style={{animationDelay:'150ms'}}/></div></div>}
                        <div ref={scrollRef} />
                    </div>
                    <div className="p-4 bg-white border-t sticky bottom-0">
                        <form onSubmit={e => {e.preventDefault(); send(input)}} className="flex gap-2">
                            <input value={input} onChange={e => setInput(e.target.value)} placeholder="Digite sua d√∫vida..." className="flex-1 p-3 bg-gray-50 border rounded-xl outline-none focus:border-orange-500" />
                            <button disabled={!input.trim() || loading} className="p-3 bg-orange-500 text-white rounded-xl disabled:opacity-50"><Send className="w-5 h-5"/></button>
                        </form>
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col h-full bg-gray-50">
                    <div className="bg-white shadow-sm flex sticky top-0 z-20">
                        <button onClick={() => setTab('plan')} className={`flex-1 py-4 text-sm font-bold flex justify-center gap-2 border-b-2 ${tab === 'plan' ? 'border-orange-500 text-orange-600' : 'border-transparent text-gray-400'}`}><Calendar className="w-4 h-4"/> Plano</button>
                        <button onClick={() => setTab('chat')} className={`flex-1 py-4 text-sm font-bold flex justify-center gap-2 border-b-2 ${tab === 'chat' ? 'border-orange-500 text-orange-600' : 'border-transparent text-gray-400'}`}><MessageCircle className="w-4 h-4"/> Chat IA</button>
                    </div>
                    <div className="flex-1 overflow-y-auto">{tab === 'plan' ? renderPlan() : renderChat()}</div>
                    {tab === 'plan' && !isVip && (
                        <div className="sticky bottom-0 z-30 bg-gray-900 text-white p-3 shadow-lg">
                            <div className="flex justify-between items-center px-2">
                                <div><div className="flex gap-1 text-orange-400 font-bold text-xs"><Clock className="w-3 h-3"/> TESTE GR√ÅTIS</div></div>
                                <div className="text-right text-xs">Depois: R$ 0,46/dia</div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- APP MAIN ---
        const App = () => {
            const [step, setStep] = useState('checking');
            const [user, setUser] = useState(null);
            const [plan, setPlan] = useState(null);
            const [isVip, setIsVip] = useState(false);

            useEffect(() => {
                const savedEmail = localStorage.getItem('nutri_user_email');
                if (savedEmail) validateAccess(savedEmail);
                else setStep('login');
            }, []);

            const validateAccess = async (email) => {
                setStep('checking');
                let u = await sheetDbService.getUserByEmail(email);
                if (!u) u = await sheetDbService.createUser(email);
                
                setUser(u);
                localStorage.setItem('nutri_user_email', email);

                if (u.status_pagamento === 'pago') {
                    setIsVip(true);
                    setStep('onboarding');
                } else {
                    const diffHours = (new Date() - new Date(u.data_cadastro)) / (1000 * 60 * 60);
                    if (diffHours < 24) {
                        setIsVip(false);
                        setStep('onboarding');
                    } else {
                        setStep('payment');
                    }
                }
            };

            const handleProfileSubmit = async (profile) => {
                setStep('loading');
                const generatedPlan = await generateMealPlan(profile);
                setPlan(generatedPlan);
                setStep('dashboard');
            };

            return (
                <div className="flex justify-center items-center min-h-screen bg-white font-sans">
                    <div className="w-full max-w-md h-[100dvh] bg-white shadow-xl overflow-hidden flex flex-col relative">
                        {step === 'checking' && <div className="h-full flex items-center justify-center"><div className="animate-spin rounded-full h-10 w-10 border-b-2 border-orange-500"></div></div>}
                        {step === 'login' && <LoginScreen onLogin={validateAccess} />}
                        {step === 'payment' && <PaymentScreen />}
                        {step === 'onboarding' && <Onboarding onSubmit={handleProfileSubmit} />}
                        {step === 'loading' && <LoadingScreen />}
                        {step === 'dashboard' && <Dashboard plan={plan} profile={user} isVip={isVip} />}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

